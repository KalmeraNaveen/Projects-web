<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Info</title>
    <link rel="icon" href="data:image/png;base64,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">
    <!-- <meta name="csrf-token" content="{% csrf_token %}"/> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    {% block style %} {% endblock %}
    <style>
        #a {
            color: palegoldenrod;
            font-family: sans-serif;
        }
        #ab {
            background-color: palegoldenrod;
        }
    </style>
    
    
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-success">
        <div class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            {% csrf_token %}
            <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
                <a class="navbar-brand" id="a" href="{% url 'weatheruser' %}">WeatherInfo</a>
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item active">
                        <a class="nav-link" id="a" href="{% url 'update' %}">UpdateAccount<span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" id="a" href="#" onclick="deleteAccount()">DeleteAccount</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" id="a" href="{% url 'logout' %}" onclick="logoutUser()">Logout</a>
                    </li>
                </ul>
                {% block search %}
                <form class="form-inline my-2 my-lg-0" onsubmit="searchCity(event)">
                    <input class="form-control mr-sm-2" list="citiesList" id="citySearch" type="search" placeholder="Search City" aria-label="Search">
                    <datalist id="citiesList"></datalist>
                    <button class="btn btn-outline-success my-2 my-sm-0" id="ab" type="submit">Search</button>
                </form>
                {% endblock %}
            </div>
        </div>
    </nav>
    {% csrf_token %}
    {% block body %}
    {% endblock %}
    <footer class="bg-dark text-white mt-5 p-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Weather Info</h5>
                    <p>Your go-to source for accurate weather information.</p>
                </div>
                <div class="col-md-8 text-md-right">
                    <ul class="list-inline mb-0">
                        <li class="list-inline-item"><a href="{% url 'userweatherdata' %}" class="text-white">Home</a></li>
                        
                    </ul>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col text-center">
                    <p>&copy; 2024 Weather Info. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function deleteAccount() {
            const email = localStorage.getItem('userEmail');
            if (!email) {
                alert('No email found in local storage.');
                return;
            }

            fetch('/usersapi/', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'email': email })
            })
            .then(response => {
                if (response.ok) {
                    alert('Account deleted successfully.');
                    localStorage.removeItem('userEmail');
                    window.location.href = '/login/';
                } else {
                    alert('Failed to delete account.');
                }
            })
            .catch(error => {
                // console.error('Error:', error);
                alert('An error occurred while deleting the account.');
            });
        }

        function logoutUser() {
            localStorage.removeItem('userEmail');
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateCityDatalist();
        });

        function populateCityDatalist() {
            function getNewTokenAndRetryPopulateDatalist() {
                fetch('/get-jwt-token/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: "hppc", 
                        password: "Hppc@123" 
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to get a new JWT token');
                    }
                    return response.json();
                })
                .then(data => {
                    const newToken = data.token;
                    localStorage.setItem('jwtToken', newToken); // Store the new token
                    fetchCities(newToken); // Retry the datalist population with the new token
                })
                .catch(error => {
                    // console.error('Error:', error);
                    alert('An error occurred while trying to refresh the token.');
                });
            }

            function fetchCities(token) {
                fetch('/api/weather/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `JWT ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            if (errorData.detail === "Signature has expired.") {
                                throw new Error('TokenExpired');
                            } else {
                                throw new Error('Failed to fetch cities');
                            }
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    const citiesList = document.getElementById('citiesList');
                    citiesList.innerHTML = ''; // Clear previous data

                    data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.City; // Assuming city.name contains the city name
                        citiesList.appendChild(option);
                    });
                })
                .catch(error => {
                    if (error.message === 'TokenExpired') {
                        getNewTokenAndRetryPopulateDatalist(); // Retry fetching cities with a new token
                    } else {
                        // console.error('Error:', error);
                        // alert('An error occurred while fetching the city list.');
                    }
                });
            }

            const token = localStorage.getItem('jwtToken');
            if (token) {
                fetchCities(token); // Start fetching cities with the existing token
            } else {
                getNewTokenAndRetryPopulateDatalist(); // No token, try to get a new one
            }
        }

        function searchCity(event) {
            event.preventDefault();
            const city = document.getElementById('citySearch').value;

            function getNewTokenAndRetrySearch() {
                fetch('/get-jwt-token/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: "hppc", 
                        password: "Hppc@123" 
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to get a new JWT token');
                    }
                    return response.json();
                })
                .then(data => {
                    const newToken = data.token;
                    localStorage.setItem('jwtToken', newToken); // Store the new token
                    fetchCityWeather(newToken); // Retry the search with the new token
                })
                .catch(error => {
                    // console.error('Error:', error);
                    alert('An error occurred while trying to refresh the token.');
                });
            }

            function fetchCityWeather(token) {
                fetch(`/api/weather/?city=${encodeURIComponent(city)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `JWT ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            if (errorData.detail === "Signature has expired.") {
                                throw new Error('TokenExpired');
                            } else {
                                throw new Error('Failed to fetch city weather data');
                            }
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    const weatherCardsContainer = document.getElementById('weather-cards');
                    weatherCardsContainer.innerHTML = ''; // Clear previous data
                    displayWeatherData([data]); // Show only the searched city data
                })
                .catch(error => {
                    if (error.message === 'TokenExpired') {
                        getNewTokenAndRetrySearch(); // Try to get a new token and retry
                    } else {
                        // console.error('Error:', error);
                        alert('An error occurred while fetching the weather data.');
                    }
                });
            }

            const token = localStorage.getItem('jwtToken');
            if (token) {
                fetchCityWeather(token); // Start the search with the existing token
            } else {
                getNewTokenAndRetrySearch(); // No token, try to get a new one
            }
        }
    </script>
</body>
</html>
